!function(){"use strict";angular.module("ml.searchAdmin",["ml.common","ml.searchAdmin.tpls","ml.search","ui.bootstrap"]).filter("decodeString",function(){return function(n){try{return decodeURIComponent(n)}catch(e){return{}}}}).directive("encodedValue",function(){return{require:"ngModel",link:function(n,e,t,a){a.$parsers.push(function(n){return encodeURIComponent(n)}),a.$formatters.push(function(n){return decodeURIComponent(n)})}}})}(),function(){"use strict";var n=angular.module("ml.searchAdmin");n.controller("EditConstraintCtrl",["$uibModalInstance","$scope","ServerConfig","rangeIndexes","constraint","constraintType",function(n,e,t,a,o,r){function i(){e.constraint.range={facet:e.constraint.range.facet||e.defaultRangeSettings.facet,"facet-option":e.constraint.range["facet-option"]||e.defaultRangeSettings["facet-option"]}}if(e.constraintTypes=_.filter(Object.keys(o),function(n){return"name"!==n&&"annotation"!==n&&o.hasOwnProperty(n)}),e.rangeConstraintType="raw",e.rangeIndexes=[],angular.forEach(a,function(n){var t=Object.keys(n)[0],a=angular.copy(n[t]);a.$label=(a["parent-localname"]?a["parent-localname"]+" ":"")+(a.localname||a["field-name"]||a["path-index"]),e.rangeIndexes.push(a)}),e.dataTypes=t.dataTypes(),e.constraintType=r||"collection",e.constraint=o,e.defaultRangeSettings={facet:!0,"facet-option":["limit=10","frequency-order","descending"]},"range"===e.constraintType&&e.constraint.range){var s=e.constraint.range;e.selectedRangeIndex=_.filter(e.rangeIndexes,function(n){var t=!1;return n["parent-localname"]&&s.element&&(t=n["parent-localname"]===s.element.name),n.localname&&s.element&&!s.attribute&&(t=n.localname===s.element.name),n.localname&&s.attribute&&(t=n.localname===s.attribute.name),n["field-name"]&&s.field&&(t=n["field-name"]===s.field.name),n["path-index"]&&s["path-index"]&&(t=n["path-index"]===s["path-index"]),"xs:"+n["scalar-type"]===e.constraint.range.type&&(n.collation===e.constraint.range.collation||!(n.collation||e.constraint.range.collation))&&t})[0];var c=s["computed-bucket"],l=s.bucket;i(),e["computed-bucket"]=c,e.constraint.range.bucket=l,l?e.rangeConstraintType="bucket":c&&(e.rangeConstraintType="computed-bucket")}e.$watch(function(){return e.rangeConstraintType},function(){i(),e.rangeConstraintType&&"raw"!==e.rangeConstraintType&&(e.constraint.range[e.rangeConstraintType]=[])}),e.save=function(){var t={name:e.constraint.name,annotation:e.constraint.annotation},a=e.constraint[e.constraintType];if(a.field&&!a.field.name&&delete a.field,a.attribute&&!a.attribute.name&&delete a.attribute,a["json-property"]&&""!==a["json-property"]||delete a["json-property"],a["path-index"]&&""!==a["path-index"]||delete a["path-index"],a.bucket&&!a.bucket.length&&delete a.bucket,a["computed-bucket"]&&!a["computed-bucket"].length&&delete a["computed-bucket"],(a.collation||"xs:string"!==a.type)&&delete a.collation,angular.forEach(a,function(n,e){/^\$/.test(e)&&delete a[e]}),t[e.constraintType]=a,"range"===e.constraintType){var o=e.selectedRangeIndex,r=t[e.constraintType];r.type="xs:"+o["scalar-type"],r.collation=o.collation,o.localname&&(r.element={name:o["parent-localname"]||o.localname,ns:o["parent-namespace-uri"]||o["namespace-uri"]}),o["parent-localname"]&&(r.attribute={name:o.localname,ns:o["namespace-uri"]}),o["field-name"]&&(r.field={name:o["field-name"],collation:o.collation})}n.close(t)}}]),n.factory("EditConstraintDialog",["$uibModal",function(n){return function(e,t){var a=angular.extend({},{name:"",annotation:"",range:{},value:{type:null,element:{ns:"",name:""},attribute:{ns:"",name:""},"json-property":"",field:{name:""},"fragment-scope":"documents","term-option":[]},collection:{prefix:"","facet-option":[],facet:!1},custom:{facet:!1,parse:{apply:"",ns:"",at:""},"start-facet":{apply:"",ns:"",at:""},"finish-facet":{apply:"",ns:"",at:""},"facet-option":[],"term-option":[]}},t||{}),o=angular.isObject(t)?_.filter(Object.keys(t),function(n){return"name"!==n&&"annotation"!==n&&t.hasOwnProperty(n)})[0]:null;return n.open({templateUrl:"/ml-search-admin/templates/editConstraint.html",controller:"EditConstraintCtrl",size:"lg",resolve:{rangeIndexes:function(){return e},constraint:function(){return a},constraintType:function(){return o||"collection"}}}).result}}])}(),function(){"use strict";angular.module("ml.searchAdmin").directive("constraintForm",[function(){function n(n,e,t){n.type=function(e){return"bucket"===n.constraintPropertyName||"computed-bucket"===n.constraintPropertyName?n.constraintPropertyName:e===!0||e===!1?"boolean":angular.isArray(e)?"array":angular.isObject(e)?"object":"string"}}return{restrict:"E",templateUrl:"/ml-search-admin/templates/constraint-form.html",scope:{constraintObject:"=",constraintPropertyName:"=",constraintProperty:"="},link:n}}])}(),function(){"use strict";angular.module("ml.searchAdmin").directive("mlConstraints",["EditConstraintDialog","SearchAdmin",function(n,e){function t(n,e,t){for(;e<0;)e+=n.length;for(;t<0;)t+=n.length;if(t>=n.length)for(var a=t-n.length;a--+1;)n.push(void 0);return n.splice(t,0,n.splice(e,1)[0]),n}function a(a,o,r){a.optionsName=a.optionsName||"all",a.resampleConstraints=function(){a.constraints=e.resampleConstraints(a.constraints,a.existingIndexes)},a.addConstraint=function(){new n(a.existingIndexes["range-index-list"]).then(function(n){a.constraints.push(n)})},a.editConstraint=function(e){new n(a.existingIndexes["range-index-list"],a.constraints[e]).then(function(n){a.constraints[e]=n})},a.removeConstraint=function(n){a.constraints.splice(n,1)},a.reorderConstraint=function(n,e){t(a.constraints,n,e)},a.submitConstraints=function(){return e.setSearchOptions(a.optionsName,{options:{constraint:a.constraints}},"constraint")}}return{restrict:"E",templateUrl:"/ml-search-admin/templates/ml-constraints.html",scope:{constraints:"=?",existingIndexes:"=?",optionsName:"=?"},link:a}}])}(),function(){"use strict";angular.module("ml.searchAdmin").directive("mlSortOptions",["SearchAdmin",function(n){function e(e,t,a){var o={};o.newSortOptionDirection="ascending",e.model=o,e.optionsName=e.optionsName||"all",e.addSortOption=function(){if(o.newSortOptionName&&o.newSortOptionRange){var n=o.newSortOptionRange.range;e.sortOptions.state.push({name:encodeURIComponent(o.newSortOptionName),"sort-order":[{direction:o.newSortOptionDirection,element:n.element,attribute:n.attribute,field:n.field,"json-property":n["json-property"]}]})}},e.removeSortOption=function(n){e.sortOptions.state.splice(n,1)},e.saveSortOptions=function(){return n.setSearchOptions(e.optionsName,{options:{operator:e.sortOptions}},"operator")}}return{restrict:"E",templateUrl:"/ml-search-admin/templates/ml-sort-options.html",scope:{constraints:"=?",sortOptions:"=?",optionsName:"=?"},link:e}}])}(),function(){"use strict";angular.module("ml.searchAdmin").directive("mlSuggestOptions",["SearchAdmin",function(n){function e(n,e){var t=[];return angular.forEach(n,function(n){if(n.range&&"xs:string"===n.range.type){var e={name:n.name,value:n.name};t.push(e)}}),t}function t(n){var e=[];if(n&&n){var t=n.ref;e.push(t)}return e.join("|")}function a(a,o,r){var i={defaultSource:t(a.defaultSource)};a.model=i,a.optionsName=a.optionsName||"all",a.saveDefaultSource=function(){var e=i.defaultSource,t={options:{"default-suggestion-source":{ref:e}}};n.setSearchOptions(a.optionsName,t,"default-suggestion-source");var o={options:{"suggestion-source":[]}};o.options["suggestion-source"]=[],angular.forEach(a.constraints,function(n){n.range&&"xs:string"===n.range.type&&o.options["suggestion-source"].push({ref:n.name})}),n.setSearchOptions(a.optionsName,o,"suggestion-source")},a.getDefaultSourceOpts=function(){i.suggestOptions=e(a.constraints,a.defaultSource)},a.$watch(function(){return a.constraints},function(n){n&&a.getDefaultSourceOpts()})}return{restrict:"E",templateUrl:"/ml-search-admin/templates/ml-suggest-options.html",scope:{constraints:"=?",sortOptions:"=?",defaultSource:"=?",optionsName:"=?"},link:a}}])}(),function(){"use strict";angular.module("ml.searchAdmin").factory("SearchAdmin",["$http","$q",function(n,e){var t={};return t.getSearchOptions=function(t,a){var o="";return a&&(o="/"+a),t=t||"all",n.get("/v1/config/query/"+t+o).then(function(n){return n.data},e.reject)},t.setSearchOptions=function(t,a,o){var r="";return o&&(r="/"+o),t=t||"all",n.put("/v1/config/query/"+t+r,a).then(function(n){return n.data},e.reject)},t.resampleConstraints=function(n,e){function t(e){var t=angular.copy(e);return delete t.name,_.some(n,function(n){var e=angular.copy(n);return delete e.name,angular.equals(e,t)})}return n=n||[],angular.forEach(e["range-index-list"],function(e){var a=e["range-element-index"]||e["range-element-attribute-index"]||e["range-field-index"]||e["range-path-index"],o=a.localname||a["field-name"]||a["path-expression"];if(o&&""!==o){var r={name:o,range:{type:"xs:"+a["scalar-type"],facet:!0,"facet-option":["limit=10","frequency-order","descending"],collation:a.collation}};a.localname&&(r.range.element={name:a["parent-localname"]||a.localname,ns:a["parent-namespace-uri"]||a["namespace-uri"]}),a["parent-localname"]&&(r.range.attribute={name:a.localname,ns:a["namespace-uri"]}),a["field-name"]&&(r.range.field={name:a["field-name"],collation:a.collation}),t(r)||n.push(r)}}),angular.forEach(e["geospatial-index-list"],function(e){var a,o=Object.keys(e)[0],r=e[o],i={heatmap:{s:-85,w:-180,n:85,e:180,latdivs:50,londivs:50}};"geospatial-element-index"===o?(a={name:r.localname,"geo-elem":i},i.element={ns:r["namespace-uri"],name:r.localname}):"geospatial-element-pair-index"===o?(a={name:r["latitude-localname"]+" "+r["longitude-localname"],"geo-elem-pair":i},i.parent={ns:r["parent-namespace-uri"],name:r["parent-localname"]},i.lat={ns:r["latitude-namespace-uri"],name:r["latitude-localname"]},i.lon={ns:r["longitude-namespace-uri"],name:r["longitude-localname"]}):"geospatial-element-attribute-pair-index"===o?(a={name:r["latitude-localname"]+" "+r["longitude-localname"],"geo-attr-pair":i},i.parent={ns:r["parent-namespace-uri"],name:r["parent-localname"]},i.lat={ns:r["latitude-namespace-uri"],name:r["latitude-localname"]},i.lon={ns:r["longitude-namespace-uri"],name:r["longitude-localname"]}):"geospatial-path-index"===o&&(a={name:r["path-index"],"geo-path":i},i["path-index"]=r["path-index"]),a&&!t(a)&&n.push(a)}),angular.forEach(e["field-list"],function(e){if(e["field-name"]&&""!==e["field-name"]){var a={name:e["field-name"],word:{field:{name:e["field-name"],collation:e.collation}}};a&&!t(a)&&n.push(a)}}),n},t.getSortOptions=function(n,e){return t.getSearchOptions(n).then(function(n){return n.options.operator?_.filter(n.options.operator,function(n){return"sort"===n.name})[0]:[]})},t}])}();